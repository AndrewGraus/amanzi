#!/bin/bash

# CMake generates this file
# Replaces each @VAR@ with value of ${VAR}

# Ensure a uniform build with the correct compiler
export TPL_INSTALL_PREFIX=@TPL_INSTALL_PREFIX@
export CC=@CMAKE_C_COMPILER@
#export CFLAGS='@hypre_cflags@'
export CXX=@CMAKE_CXX_COMPILER@
#export CXXFLAGS='@hypre_cxxflags@'
export F77=@CMAKE_Fortran_COMPILER@
#export FFLAGS='-g -fPIC'
export FFLAGS='@Amanzi_COMMON_FCFLAGS@ -g'
#export PETSC_DIR='@PETSc_DIR@'

# pflotran in-source build under src
# NOTE: PFlotran doesn't seem parallel-build safe, since it has F90
# NOTE: modules that need to be built before other things, and dependencies
# NOTE: aren't expressed properly. The -j1 flag ensures that the build is
# NOTE: serial.
cd @ECOSIM_source_dir@

git checkout agraus/ats_seb

echo "In ATS-Ecosim install script: "
echo "ECOSIM_LIBRARIES: $ECOSIM_LIBRARIES"
echo "TPL_INSTALL_PREFIX: $TPL_INSTALL_PREFIX"
echo "AMANZI_TPLS_BUILD_DIR: $AMANZI_TPLS_BUILD_DIR"

make -j1 install ATS=1 SHARED=1 DEBUG=1

rc=$?

if [ $rc -eq 0 ]; then
  echo "copying data to install"

  cp -r $AMANZI_TPLS_BUILD_DIR/ecosim/ecosim--source $AMANZI_TPLS_INSTALL_DIR
  cd $AMANZI_TPLS_INSTALL_DIR

  mv ecosim--source/ ecosim/

  cd $AMANZI_TPLS_INSTALL_DIR/ecosim

  mkdir local/lib

  find . -name lib*.a -exec cp {} ./local/lib/ \;
else
  echo "Skipping copying data to install due to build failure."
fi

echo "make ecosim returned $rc"

exit $rc
