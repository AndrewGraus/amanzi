FROM metsi/amanzi:${amanzi_branch}-temp-build-stage-1
LABEL Description="Amanzi: Build stage 2 and install in temporary Docker image."

# Arguments
ARG amanzi_branch=master
RUN echo "Amanzi branch = ${amanzi_branch}"
  
# Switch to amanzi_user
USER amanzi_user

# Installation paths
ENV AMANZI_PREFIX=/home/amanzi_user/install \
    AMANZI_INSTALL_DIR=/home/amanzi_user/install/amanzi \
    AMANZI_TPLS_DIR=/home/amanzi_user/install/tpls

# Change the Working Directory and update amanzi
WORKDIR /home/amanzi_user/amanzi

RUN ./bootstrap.sh --prefix=${AMANZI_PREFIX} \
   --amanzi-build-dir=/home/amanzi_user/amanzi_builddir/amanzi \
   --tpl-config-file=${AMANZI_TPLS_DIR}/share/cmake/amanzi-tpl-config.cmake \
   --parallel=4 --opt \
   --disable-structured \
   --enable-alquimia --enable-pflotran --enable-crunchtope \
   --with-mpi=/usr \
   --enable-shared \
   --enable-build_stage_2


